---
# Copyright (C) 2020 Stefan Hornburg (Racke) <racke@linuxia.de>
# SPDX-License-Identifier: Artistic-2.0

- name: Ensure that installation directory exists
  file:
    state: directory
    path: "{{ sympa_installation_directory }}"
    owner: "{{ sympa_unix_user }}"
    group: "{{ sympa_unix_group }}"
    mode: 0755

- name: Install stuff we need for compiling
  package:
    name:
      - gcc
      - autoconf
      - automake
      - "{% if ansible_os_family == 'Suse' %}gettext-tools{% elif ansible_os_family == 'RedHat' %}gettext-devel{% else %}gettext{% endif %}" 
  
- name: Run autoconf
  command: autoreconf -i
  args:
    chdir: "{{ sympa_source_directory }}"
  become_user: "{{ sympa_unix_user }}"
  vars:
    ansible_ssh_pipelining: true  
  when: sympa_installation_method != 'source'

- name: Configure Sympa
  command: |
    ./configure --prefix="{{ sympa_installation_directory }}" --with-lockdir=/var/lock
    {% if ansible_os_family != 'FreeBSD' %} --without-initdir{% else %}--with-initdir=/etc/rc.d{% endif %}
    {% if not sympa_build_options.setuid_fcgi %} --disable-setuid_fcgi
    {% endif %}
    {% if not sympa_build_options.setuid_queue %} --disable-setuid_queue
    {% endif %}
    --without-smrshdir
  args:
    chdir: "{{ sympa_source_directory }}"
  become_user: "{{ sympa_unix_user }}"
  vars:
    ansible_ssh_pipelining: true  

- name: Make Sympa
  command: make
  args:
    chdir: "{{ sympa_source_directory }}"
  become_user: "{{ sympa_unix_user }}"
  vars:
    ansible_ssh_pipelining: true

- name: Install Sympa
  command: make install
  args:
    chdir: "{{ sympa_source_directory }}"
  become_user: "{{ sympa_unix_user }}"
  vars:
    ansible_ssh_pipelining: true

- name: Set variable for Sympa command
  set_fact:
    sympa_command: "/home/{{ sympa_unix_user }}/bin/sympa.pl"
